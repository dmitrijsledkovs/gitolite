<p><head><style>
    body        { margin-left:  40px;   font-size:  0.9em;  font-family: sans-serif; max-width: 800px; }
    h1          { margin-left: -30px;   border-bottom: 5px  solid #ccc; }
    h2, h3      { margin-left: -30px;   border-top:    3px  solid #ddd; }
    h4, h5      { margin-left: -20px; }
    code        { font-size:    1.1em;  background:  #eee; }
    pre         { margin-left:  2em;    background:  #eee; }
    pre code    { font-size:    1.1em;  background:  #eee; }
</style></head></p>

<h1>migrating from gitosis to gitolite</h1>

<p>[TODO: make the migration tool fix up gitweb and daemon control also...]</p>

<p>Migrating from gitosis to gitolite is pretty easy, because the basic design is
the same.</p>

<p>Here's how we migrated my work repos:</p>

<ol>
<li><p>login as the <code>git</code> user on the server, and get a bash shell prompt</p></li>
<li><p><strong>disable gitosis</strong> by renaming <code>/usr/bin/gitosis-serve</code> to something
else.  This will prevent users from pushing anything while you do the
backup, migration, etc.</p></li>
<li><p><strong>edit</strong> <code>~/.ssh/authorized_keys</code> and <strong>carefully</strong> remove all the lines
containing "gitosis-serve", as well as the marker line that says
"auto-generated by gitosis, DO NOT REMOVE", then save the file.  If the
file did not have any other keys and is now empty, don't worry -- save it
anyway because gitolite expects the file to be present (even if it is
empty).</p></li>
<li><p>For added safety, <strong>delete</strong> the post-update hook that gitosis-admin
installed</p>

<pre><code>rm ~/repositories/gitosis-admin.git/hooks/post-update
</code></pre>

<p>or at least rename it to <code>.sample</code> like all the other hooks hanging
around, or edit it and comment out the line that calls <code>gitosis-run-hook
post-update</code>.</p>

<p>If you do not do this, an accidental push to the gitosis-admin repo will
mess up your <code>~/.ssh/authorized_keys</code> file</p></li>
<li><p>If you already use the <code>update</code> hook for some reason, <strong>rename</strong> it (on
each individual repository) to <code>update.secondary</code>.  This is because
gitolite uses the update hook for checking write access.</p></li>
<li><p>take a <strong>backup</strong> of the <code>~/repositories</code> directory</p></li>
</ol>

<p>Now, log off the server and get back to the client:</p>

<ol>
<li><p>follow instructions to install gitolite; see the <a href="http://sitaramc.github.com/gitolite/doc/1-INSTALL.html">install document</a>.
Make sure that you <strong>don't</strong> change the default path for <code>$REPO_BASE</code> if
you edit the config file!</p>

<p>This will give you a gitolite config that has the required entries for the
"gitolite-admin" repo.</p></li>
<li><p><strong>convert</strong> your gitosis config file and append it to your gitolite config
file.  Substitute the path for your gitosis-admin clone in <code>$GSAC</code> below,
and similarly the path for your gito<strong>lite</strong>-admin clone in <code>$GLAC</code></p>

<pre><code>src/gl-conf-convert &lt; $GSAC/gitosis.conf &gt;&gt; $GLAC/gitolite.conf
</code></pre>

<p>Be sure to check the file to make sure it converted correctly</p></li>
<li><p><strong>copy</strong> the keys from gitosis's keydir (same meanings for GSAC and GLAC)</p>

<pre><code>cp $GSAC/keydir/* $GLAC/keydir
</code></pre></li>
<li><p><strong>IMPORTANT</strong>: if you have any users with names like <code>user@foo</code>, where the
part after the <code>@</code> does <em>not</em> have a <code>.</code> in it (i.e., does not look like
an email address), you need to change them, because gitolite uses that
syntax for enabling multi keys.</p>

<p>You have two choices in how to fix this.  You can change the gitolite
config so that all mention of <code>user@foo</code> is changed to just <code>user</code>.</p>

<p>Or you can change each occurrence of <code>user@foo</code> to, say, <code>user_foo</code> <em>and</em>
change the pubkey filename in keydir/ also the same way (<code>user_foo.pub</code>).</p>

<p>Just to repeat, you do NOT need to do this if the username was like
<code>user@foo.bar</code>, i.e., the part after the <code>@</code> had a <code>.</code> in it, because then
it looks like an email address.</p>

<p><a href="http://sitaramc.github.com/gitolite/doc/3-faq-tips-etc.html#multikeys">This</a> will tell you more about these nuances.</p></li>
<li><p><strong>IMPORTANT: expand any multi-key files you may have</strong>.  <a href="http://sitaramc.github.com/gitolite/doc/3-faq-tips-etc.html#multikeys">Here</a>'s an
explanation of what multi-keys are, how gitosis does them and how gitolite
does it differently.</p>

<p>You can split the keys manually, or use the following code (just
copy-paste it into your xterm after "cd"-ing to your gitolite-admin repo
clone):</p>

<pre><code>wc -l keydir/*.pub | grep -v total | grep -v -w 1 | while read a b
do
    i=1
    cat $b|while read l
    do
        echo "$l" &gt; ${b%.pub}@$i.pub
        (( i++ ))
    done
    mv $b $b.done
done
</code></pre>

<p>This will split each multi-key file (say "sitaram.pub") into individual
files called "sitaram@1.pub", "sitaram@2.pub", etc., and rename the
original to "sitaram.pub.done" so gitolite won't pick it up.</p>

<p>At this point you can rename the split parts more appropriately, like
"sitaram@laptop.pub" and "sitaram@desktop.pub" or whatever.  <em>Please check
the files to make sure this worked properly</em></p></li>
<li><p>Check all your changes to your gitolite-admin clone, commit, and push</p></li>
</ol>
